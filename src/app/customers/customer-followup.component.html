<div class="page-container">
  <div class="content-wrapper">
    <!-- Header Section -->
    <div class="page-header">
      <div class="header-title">
        <h2>Customer Followup</h2>
        <p class="subtitle">Manage customer visits and schedule follow-ups</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="openDialog()">
          <span class="icon">‚öôÔ∏è</span> Show / Hide Columns
        </button>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="card main-card">
      <div class="table-container">
        <table class="data-grid">
          <thead>
            <tr>
              <th *ngFor="let col of visibleColumns" [class]="'col-' + col">
                {{ getLabel(col) }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let customer of customers" class="data-row">
              <td *ngFor="let col of visibleColumns" [class]="'col-' + col">
                <ng-container *ngIf="col !== 'remarks'">
                  {{ customer[col] }}
                </ng-container>
                <div *ngIf="col === 'remarks'" class="cell-with-action">
                  <span class="cell-text">{{ customer[col] }}</span>
                  <button class="btn-icon-pill small-btn" (click)="followupCustomer(customer)">
                    <span class="icon">üìû</span> Followup
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="customers.length === 0" class="empty-state">
              <td [attr.colspan]="visibleColumns.length">
                <div class="empty-content">
                  <span class="empty-icon">üìÇ</span>
                  <p>No customers found.</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Column Configuration Modal -->
  <div class="modal-backdrop" *ngIf="showDialog" (click)="closeDialog()">
    <div class="modal-card config-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Column Configuration</h3>
        <button class="btn-close" (click)="closeDialog()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-instruction">Select columns to display in the table:</p>
        <div class="toggle-grid">
          <label *ngFor="let field of fields" class="toggle-checkbox">
            <input type="checkbox" [(ngModel)]="field.visible" />
            <span class="checkmark"></span>
            <span class="label-text">{{ field.label }}</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDialog()">Close</button>
        <button class="btn btn-primary" (click)="closeDialog()">
          Apply Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Follow-up Details Modal -->
  <div class="modal-backdrop" *ngIf="showFollowupPopup" (click)="closeFollowupPopup()">
    <div class="modal-card followup-modal big-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Update Activity</h3>
        <button class="btn-close" (click)="closeFollowupPopup()">
          &times;
        </button>
      </div>

      <div class="modal-body with-sidebar">
        <!-- Main Form Area -->
        <div class="modal-main">
          <div class="customer-banner">
            <div class="avatar-placeholder">
              {{ (selectedCustomer["name"] || "C")[0] }}
            </div>
            <div class="customer-details">
              <h4>{{ selectedCustomer["name"] || "Unknown Customer" }}</h4>
              <div class="meta-row">
                <span class="meta-pill">üì± {{ selectedCustomer["mobileno"] || "N/A" }}</span>
                <span class="meta-pill">üìç {{ selectedCustomer["location"] || "N/A" }}</span>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h4 class="section-title">New Visit Entry</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="dateofvisit">Date of Visit</label>
                <div class="input-wrapper">
                  <input type="datetime-local" id="dateofvisit" [(ngModel)]="followupForm.dateofvisit"
                    class="form-input" />
                </div>
              </div>
              <div class="form-group">
                <label for="nextvisit">Next Visit (Optional)</label>
                <div class="input-wrapper">
                  <input type="datetime-local" id="nextvisit" [(ngModel)]="followupForm.nextvisit" class="form-input" />
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="remarks">Remarks</label>
              <textarea id="remarks" [(ngModel)]="followupForm.remarks" class="form-input textarea" rows="4"
                placeholder="Enter detailed remarks about the interaction..."></textarea>
            </div>
          </div>
        </div>

        <!-- Sidebar / History -->
        <div class="modal-sidebar">
          <h4 class="sidebar-title">Interaction History</h4>
          <div class="history-timeline">
            <div *ngIf="loadingHistory" class="loading-spinner"></div>
            <div *ngIf="!loadingHistory && previousHistory.length === 0" class="empty-history">
              No previous history
            </div>

            <div *ngFor="let history of previousHistory" class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-date">{{ history["dateofvisit"] }}</div>
                <div class="timeline-remarks">{{ history["remarks"] }}</div>
                <div class="timeline-meta" *ngIf="history['nextvisit']">
                  Next: {{ history["nextvisit"] }}
                </div>
                <div class="timeline-author">
                  By:
                  {{ history["visitby"] || history["empname"] || "Unknown" }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeFollowupPopup()">
          Cancel
        </button>
        <button class="btn btn-primary" (click)="saveFollowupDetails()">
          Save Entry
        </button>
      </div>
    </div>
  </div>
</div>